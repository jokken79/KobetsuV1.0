# Dependabot configuration for automatic dependency updates
# https://docs.github.com/github/administering-a-repository/configuration-options-for-dependency-updates

version: 2
updates:
  # Python dependencies (Backend)
  - package-ecosystem: "pip"
    directory: "/backend"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "04:00"
    open-pull-requests-limit: 5
    reviewers:
      - "backend-team"
    labels:
      - "dependencies"
      - "backend"
      - "python"
    groups:
      # Group all patch updates together
      patch-updates:
        patterns:
          - "*"
        update-types:
          - "patch"
      # Group all minor updates together
      minor-updates:
        patterns:
          - "*"
        update-types:
          - "minor"
    commit-message:
      prefix: "chore(deps)"
      include: "scope"
    ignore:
      # Don't update these dependencies automatically
      - dependency-name: "sqlalchemy"
        update-types: ["version-update:semver-major"]
      - dependency-name: "alembic"
        update-types: ["version-update:semver-major"]

  # JavaScript/npm dependencies (Frontend)
  - package-ecosystem: "npm"
    directory: "/frontend"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "04:00"
    open-pull-requests-limit: 5
    reviewers:
      - "frontend-team"
    labels:
      - "dependencies"
      - "frontend"
      - "javascript"
    groups:
      # Group React-related updates
      react:
        patterns:
          - "react"
          - "react-*"
          - "@types/react*"
      # Group Next.js updates
      nextjs:
        patterns:
          - "next"
          - "next-*"
          - "@next/*"
      # Group testing libraries
      testing:
        patterns:
          - "@testing-library/*"
          - "jest*"
          - "vitest*"
      # Group ESLint and Prettier
      linting:
        patterns:
          - "eslint*"
          - "prettier*"
          - "@typescript-eslint/*"
      # Group all patch updates
      patch-updates:
        patterns:
          - "*"
        update-types:
          - "patch"
      # Group all minor updates
      minor-updates:
        patterns:
          - "*"
        update-types:
          - "minor"
    commit-message:
      prefix: "chore(deps)"
      include: "scope"
    ignore:
      # Don't auto-update major versions of critical dependencies
      - dependency-name: "next"
        update-types: ["version-update:semver-major"]
      - dependency-name: "react"
        update-types: ["version-update:semver-major"]
      - dependency-name: "typescript"
        update-types: ["version-update:semver-major"]

  # Docker base images
  - package-ecosystem: "docker"
    directory: "/backend"
    schedule:
      interval: "weekly"
      day: "sunday"
      time: "02:00"
    reviewers:
      - "devops-team"
    labels:
      - "dependencies"
      - "docker"
      - "backend"
    commit-message:
      prefix: "chore(docker)"

  - package-ecosystem: "docker"
    directory: "/frontend"
    schedule:
      interval: "weekly"
      day: "sunday"
      time: "02:00"
    reviewers:
      - "devops-team"
    labels:
      - "dependencies"
      - "docker"
      - "frontend"
    commit-message:
      prefix: "chore(docker)"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "sunday"
      time: "03:00"
    reviewers:
      - "devops-team"
    labels:
      - "dependencies"
      - "github-actions"
      - "ci"
    commit-message:
      prefix: "ci(actions)"
    groups:
      # Group all GitHub Actions updates together
      actions:
        patterns:
          - "*"

# Security updates are always created immediately
# regardless of any schedule when Dependabot detects
# a vulnerable dependency

# Configuration for batched updates and review requirements
registries:
  docker-hub:
    type: docker-registry
    url: https://registry.hub.docker.com
    username: ${{ secrets.DOCKER_USERNAME }}
    password: ${{ secrets.DOCKER_PASSWORD }}

# Additional configuration for better dependency management
allow:
  # Allow specific types of updates
  - dependency-type: "direct"
  - dependency-type: "indirect"
  - dependency-type: "production"
  - dependency-type: "development"

# Define update behavior for different dependency types
assignees:
  - "dependabot[bot]"

# Auto-merge configuration for safe updates
auto-merge:
  # Only auto-merge patch updates for documentation and dev dependencies
  - dependency-type: "development"
    update-types: ["patch"]
    auto-merge: true
  - dependency-type: "production"
    update-types: ["patch"]
    # Only auto-merge if all checks pass
    auto-merge: true
    required-status-checks:
      strict: true
      contexts:
        - "CI - Backend"
        - "CI - Frontend"
        - "Security Scan"

# Advanced grouping for better organization
groups:
  # Security updates group (highest priority)
  security-updates:
    patterns:
      - "*"
    update-types:
      - "security"
    dependency-type: "all"
    applies-to: "security-updates"

  # Major version updates (require manual review)
  major-updates:
    patterns:
      - "*"
    update-types:
      - "major"
    applies-to: "version-updates"

  # Development dependencies
  dev-dependencies:
    patterns:
      - "*"
    dependency-type: "development"
    applies-to: "development"

# Custom labels for better categorization
labels:
  # Priority labels
  - "priority-security"  # Security updates
  - "priority-high"      # Major updates
  - "priority-medium"    # Minor updates
  - "priority-low"       # Patch updates

  # Type labels
  - "type-security"       # Security updates
  - "type-feature"       # New features in deps
  - "type-bugfix"       # Bug fixes in deps
  - "type-chore"        # Maintenance updates

  # Component labels
  - "component-backend"   # Backend deps
  - "component-frontend"  # Frontend deps
  - "component-infra"    # Infrastructure deps
  - "component-docs"      # Documentation deps

# Review requirements based on update type
review-requirements:
  security-updates:
    required-reviewers: 2
    dismiss-stale-reviews: false
    require-up-to-date: true
  major-updates:
    required-reviewers: 2
    dismiss-stale-reviews: false
    require-up-to-date: true
  minor-updates:
    required-reviewers: 1
    dismiss-stale-reviews: true
    require-up-to-date: false
  patch-updates:
    required-reviewers: 1
    dismiss-stale-reviews: true
    require-up-to-date: false

# Notification settings
notifications:
  # Notify on security updates immediately
  on-security-update: true
  # Notify on failed updates
  on-update-failure: true
  # Daily digest of all updates
  digest: true
  schedule: "daily"

# Quality checks for dependency updates
quality-checks:
  # Run security scan on all updates
  security-scan: true
  # Check for breaking changes
  breaking-change-check: true
  # Validate compatibility
  compatibility-check: true
  # Check license compatibility
  license-check: true

# Rate limiting to avoid overwhelming the team
rate-limit:
  # Maximum PRs per day
  daily-limit: 10
  # Maximum PRs per week
  weekly-limit: 25
  # Priority for security updates
  security-override: true