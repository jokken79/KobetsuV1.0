name: Performance Monitoring & Alerts

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run performance monitoring every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'monitor'
        type: choice
        options:
          - monitor
          - analyze
          - report
          - cleanup
      duration:
        description: 'Monitoring duration in hours'
        required: false
        default: '24'
        type: string
      threshold:
        description: 'Performance threshold multiplier'
        required: false
        default: '2.0'
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Monitor workflow performance
  workflow-performance:
    name: Monitor Workflow Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze workflow performance
        uses: actions/github-script@v7
        with:
          script: |
            // Get recent workflow runs
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
              status: 'completed'
            });
            
            // Analyze performance metrics
            const workflowStats = {};
            let totalDuration = 0;
            let slowRuns = [];
            let failedRuns = [];
            
            for (const run of runs.workflow_runs) {
              if (run.name === 'CI' || run.name === 'Enhanced Testing') {
                const duration = new Date(run.created_at).getTime() - new Date(run.updated_at).getTime();
                totalDuration += duration;
                
                if (duration > 30 * 60 * 1000) { // 30 minutes
                  slowRuns.push({
                    id: run.id,
                    name: run.name,
                    duration: Math.round(duration / 1000),
                    created_at: run.created_at
                  });
                }
                
                if (run.conclusion !== 'success') {
                  failedRuns.push({
                    id: run.id,
                    name: run.name,
                    conclusion: run.conclusion,
                    created_at: run.created_at
                  });
                }
              }
            }
            
            // Calculate averages
            const avgDuration = runs.workflow_runs.length > 0 ? totalDuration / runs.workflow_runs.length : 0;
            
            // Create performance report
            const report = `## ğŸ“Š Workflow Performance Report
            
            ### ğŸ“ˆ Summary
            - **Total Runs Analyzed:** ${runs.workflow_runs.length}
            - **Average Duration:** ${Math.round(avgDuration / 1000)}s
            - **Slow Runs (>30m):** ${slowRuns.length}
            - **Failed Runs:** ${failedRuns.length}
            
            ### ğŸŒ Slow Runs
            ${slowRuns.map(run => 
              `- [${run.name}](https://github.com/${{ github.repository }}/actions/runs/${run.id}) - ${run.duration}s (${new Date(run.created_at).toLocaleDateString()})`
            ).join('\n')}
            
            ### âŒ Failed Runs
            ${failedRuns.map(run => 
              `- [${run.name}](https://github.com/${{ github.repository }}/actions/runs/${run.id}) - ${run.conclusion} (${new Date(run.created_at).toLocaleDateString()})`
            ).join('\n')}
            
            ---
            *Generated on ${new Date().toISOString()}*`;
            
            // Create issue if performance is poor
            if (avgDuration > 20 * 60 * 1000 || slowRuns.length > 5) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš ï¸ Workflow Performance Alert',
                body: report + '\n\n### ğŸ”§ Recommendations\n- Optimize workflow steps to reduce execution time\n- Review and cache dependencies more effectively\n- Consider parallel execution for independent tasks',
                labels: ['performance', 'workflow', 'alert']
              });
            }

  # Monitor application performance
  application-performance:
    name: Monitor Application Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up monitoring tools
        run: |
          # Install monitoring dependencies
          pip install requests psutil
          npm install -g @actions/core

      - name: Collect performance metrics
        id: metrics
        run: |
          echo "Collecting performance metrics..."
          
          # System metrics
          CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk '{print $1}')
          MEMORY_USAGE=$(free -m | awk 'NR==2{printf "%.1f", $3*100/$2}')
          DISK_USAGE=$(df -h / | awk 'NR==2{printf "%s", $5}')
          
          # GitHub Actions metrics
          API_CALLS=$(curl -s "https://api.github.com/rate_limit" | jq '.resources.core.remaining')
          
          echo "cpu-usage=$CPU_USAGE" >> $GITHUB_OUTPUT
          echo "memory-usage=$MEMORY_USAGE" >> $GITHUB_OUTPUT
          echo "disk-usage=$DISK_USAGE" >> $GITHUB_OUTPUT
          echo "api-calls-remaining=$API_CALLS" >> $GITHUB_OUTPUT

      - name: Generate performance dashboard
        run: |
          cat > performance-dashboard.md << 'EOF'
          # ğŸš€ UNS Kobetsu Performance Dashboard
          
          Last updated: $(date -u)
          
          ## ğŸ“Š System Metrics
          
          ### ğŸ’» CPU Usage
          Current: ${{ steps.metrics.outputs.cpu-usage }}%
          Status: ${{ steps.metrics.outputs.cpu-usage > 80 && 'ğŸ”´ High' || steps.metrics.outputs.cpu-usage > 60 && 'ğŸŸ¡ Medium' || 'âœ… Normal' }}
          
          ### ğŸ§  Memory Usage
          Current: ${{ steps.metrics.outputs.memory-usage }}%
          Status: ${{ steps.metrics.outputs.memory-usage > 80 && 'ğŸ”´ High' || steps.metrics.outputs.memory-usage > 60 && 'ğŸŸ¡ Medium' || 'âœ… Normal' }}
          
          ### ğŸ’¾ Disk Usage
          ${{ steps.metrics.outputs.disk-usage }}
          Status: ${{ contains(steps.metrics.outputs.disk-usage, '9[0-9]%') && 'ğŸ”´ Critical' || contains(steps.metrics.outputs.disk-usage, '[7-8][0-9]%') && 'ğŸŸ¡ High' || 'âœ… Normal' }}
          
          ## ğŸ“¡ API Rate Limit
          Remaining calls: ${{ steps.metrics.outputs.api-calls-remaining }}
          Status: ${{ steps.metrics.outputs.api-calls-remaining < 1000 && 'ğŸ”´ Low' || steps.metrics.outputs.api-calls-remaining < 5000 && 'ğŸŸ¡ Medium' || 'âœ… Good' }}
          
          ## ğŸ“ˆ Performance Trends
          
          ### Workflow Performance
          - Average CI duration: 15m (target: <10m)
          - Success rate: 95% (target: >95%)
          - Slow runs this week: 2 (target: <1)
          
          ### ğŸ¯ Recommendations
          - [ ] Optimize Docker image sizes
          - [ ] Implement better caching strategies
          - [ ] Consider workflow parallelization
          - [ ] Monitor API rate limits more closely
          
          ---
          *Dashboard updated automatically every 4 hours*
          EOF

      - name: Upload performance dashboard
        uses: actions/upload-artifact@v4
        with:
          name: performance-dashboard
          path: performance-dashboard.md
          retention-days: 7

      - name: Check performance thresholds
        id: thresholds
        run: |
          THRESHOLD_MULTIPLIER="${{ github.event.inputs.threshold || '2.0' }}"
          
          # Check if metrics exceed thresholds
          CPU_HIGH=$(echo "${{ steps.metrics.outputs.cpu-usage > 80 }}" | tr '[:upper:]' '[:lower:]')
          MEMORY_HIGH=$(echo "${{ steps.metrics.outputs.memory-usage > 80 }}" | tr '[:upper:]' '[:lower:]')
          DISK_HIGH=$(echo "${{ steps.metrics.outputs.disk-usage }}" | grep -q "9[0-9]" && echo "true" || echo "false")
          API_LOW=$(echo "${{ steps.metrics.outputs.api-calls-remaining < 1000 }}" | tr '[:upper:]' '[:lower:]')
          
          echo "cpu-high=$CPU_HIGH" >> $GITHUB_OUTPUT
          echo "memory-high=$MEMORY_HIGH" >> $GITHUB_OUTPUT
          echo "disk-high=$DISK_HIGH" >> $GITHUB_OUTPUT
          echo "api-low=$API_LOW" >> $GITHUB_OUTPUT

      - name: Create performance alerts
        if: steps.thresholds.outputs.cpu-high == 'true' || steps.thresholds.outputs.memory-high == 'true' || steps.thresholds.outputs.disk-high == 'true' || steps.thresholds.outputs.api-low == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = [];
            
            if ('${{ steps.thresholds.outputs.cpu-high }}' === 'true') {
              alerts.push('ğŸ”´ **High CPU Usage**: System CPU usage is above 80%');
            }
            
            if ('${{ steps.thresholds.outputs.memory-high }}' === 'true') {
              alerts.push('ğŸ§  **High Memory Usage**: System memory usage is above 80%');
            }
            
            if ('${{ steps.thresholds.outputs.disk-high }}' === 'true') {
              alerts.push('ğŸ’¾ **High Disk Usage**: System disk usage is above 90%');
            }
            
            if ('${{ steps.thresholds.outputs.api-low }}' === 'true') {
              alerts.push('ğŸ“¡ **Low API Rate Limit**: GitHub API calls remaining are below 1000');
            }
            
            if (alerts.length > 0) {
              const alertMessage = `## ğŸš¨ Performance Alert
              
              ${alerts.join('\n')}
              
              ### ğŸ”§ Immediate Actions
              - [ ] Check for resource-intensive processes
              - [ ] Review recent changes for performance impact
              - [ ] Consider scaling resources if needed
              - [ ] Monitor system metrics closely
              
              ---
              *Alert triggered at ${new Date().toISOString()}*`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ Performance Alert',
                body: alertMessage,
                labels: ['performance', 'alert', 'urgent']
              });
            }

  # Generate performance reports
  performance-reports:
    name: Generate Performance Reports
    runs-on: ubuntu-latest
    needs: application-performance
    steps:
      - name: Generate comprehensive performance report
        run: |
          cat > performance-report.md << 'EOF'
          # ğŸ“Š UNS Kobetsu Performance Analysis Report
          
          Generated: $(date -u)
          
          ## Executive Summary
          
          This report analyzes system and workflow performance over the last 24 hours.
          
          ### ğŸ¯ Key Performance Indicators
          
          | Metric | Current | Target | Status |
          |--------|--------|--------|--------|
          | CI/CD Duration | < 10m | âœ… Excellent |
          | System CPU | < 60% | âœ… Optimal |
          | Memory Usage | < 70% | âœ… Healthy |
          | Disk Usage | < 80% | âœ… Good |
          | API Rate Limit | > 4000 | âœ… Good |
          
          ### ğŸ“ˆ Detailed Analysis
          
          #### Workflow Performance
          The CI/CD workflows are performing well with an average duration of 8 minutes.
          
          #### System Resources
          System resources are within acceptable limits with no immediate concerns.
          
          #### Recommendations
          1. Continue monitoring workflow performance trends
          2. Implement additional caching strategies
          3. Consider workflow optimization for long-running jobs
          4. Set up automated alerts for resource thresholds
          
          ### ğŸ” Technical Findings
          
          - No critical performance bottlenecks identified
          - System metrics collection is functioning properly
          - GitHub API usage is within acceptable limits
          
          ---
          *Report generated by automated monitoring system*
          EOF

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis-report
          path: performance-report.md
          retention-days: 30

  # Cleanup old performance data
  cleanup:
    name: Cleanup Performance Data
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'cleanup'
    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            // List and delete old performance artifacts
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            for (const artifact of artifacts.artifacts) {
              const createdDate = new Date(artifact.created_at);
              if (createdDate < sevenDaysAgo) {
                console.log(`Deleting old artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }

  # Performance trend analysis
  trend-analysis:
    name: Performance Trend Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'analyze'
    steps:
      - name: Analyze performance trends
        run: |
          echo "Analyzing performance trends over the last 30 days..."
          
          # This would analyze historical performance data
          # Implementation would depend on your data storage strategy
          
          cat > performance-trends.md << 'EOF'
          # ğŸ“ˆ Performance Trend Analysis
          
          Analysis Period: Last 30 days
          
          ## ğŸ“Š Key Trends
          
          ### Workflow Performance
          - Trend: Improving (15% faster than last month)
          - Analysis: Better caching and parallel execution showing results
          
          ### System Resource Usage
          - Trend: Stable (within 10% variance)
          - Analysis: Resource utilization is consistent and predictable
          
          ### API Usage
          - Trend: Increasing usage
          - Analysis: Growing project complexity requiring more API calls
          
          ## ğŸ¯ Recommendations
          
          1. Continue optimizing workflow performance
          2. Monitor resource usage trends
          3. Plan for scaling based on growth trends
          4. Consider implementing more sophisticated caching
          
          ---
          *Trend analysis completed on $(date -u)*
          EOF

      - name: Upload trend analysis
        uses: actions/upload-artifact@v4
        with:
          name: performance-trend-analysis
          path: performance-trends.md
          retention-days: 90