name: Caching Optimization

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/requirements*.txt'
      - 'frontend/package*.json'
      - 'docker-compose.yml'
      - '.github/workflows/caching-optimization.yml'
  pull_request:
    branches: [main, develop]
  schedule:
    # Run cache optimization analysis weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'analyze'
        type: choice
        options:
          - analyze
          - optimize
          - cleanup
          - warmup
      cache-type:
        description: 'Cache type to optimize'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dependencies
          - docker
          - build
          - test

permissions:
  contents: read
  actions: read
  issues: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Analyze cache usage and efficiency
  analyze-cache-usage:
    name: Analyze Cache Usage
    runs-on: ubuntu-latest
    outputs:
      cache-hit-rate: ${{ steps.analysis.outputs.hit-rate }}
      total-cache-size: ${{ steps.analysis.outputs.total-size }}
      recommendations: ${{ steps.analysis.outputs.recommendations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze cache performance
        id: analysis
        run: |
          echo "Analyzing cache usage and efficiency..."
          
          # Get cache usage statistics
          CACHE_STATS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/cache/usage" | \
            jq '[.actions_cache_usage[]] | select(.cache_version == "v1") | {total_cache_size: .total_cache_size_mb, cache_hits: .cache_hits, cache_misses: .cache_misses}')
          
          TOTAL_SIZE=$(echo "$CACHE_STATS" | jq '.total_cache_size_mb')
          HITS=$(echo "$CACHE_STATS" | jq '.cache_hits')
          MISSES=$(echo "$CACHE_STATS" | jq '.cache_misses')
          
          # Calculate hit rate
          if [ "$((HITS + MISSES))" -gt 0 ]; then
            HIT_RATE=$(echo "scale=2; $HITS / ($HITS + $MISSES)" | bc)
          else
            HIT_RATE="0"
          fi
          
          echo "hit-rate=$HIT_RATE" >> $GITHUB_OUTPUT
          echo "total-size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          
          # Generate recommendations
          RECOMMENDATIONS=""
          if [ "$(echo "$HIT_RATE | cut -d. -f1)" -lt 80 ]; then
            RECOMMENDATIONS="Consider increasing cache scope or improving cache keys"
          fi
          if [ "$(echo "$TOTAL_SIZE" | cut -d. -f1)" -gt 5000 ]; then
            RECOMMENDATIONS="Cache size is large, consider optimizing cached content"
          fi
          
          echo "recommendations=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          
          echo "Cache Analysis Results:"
          echo "- Total Cache Size: ${TOTAL_SIZE}MB"
          echo "- Cache Hits: $HITS"
          echo "- Cache Misses: $MISSES"
          echo "- Hit Rate: ${HIT_RATE}%"

      - name: Generate cache optimization report
        run: |
          cat > cache-optimization-report.md << 'EOF
          # üìä Cache Optimization Report
          
          Generated: $(date -u)
          
          ## üìà Cache Performance Metrics
          
          ### Overall Statistics
          - **Total Cache Size:** ${{ steps.analysis.outputs.total-size }}MB
          - **Cache Hit Rate:** ${{ steps.analysis.outputs.hit-rate }}%
          - **Status:** ${{ steps.analysis.outputs.hit-rate > 80 && '‚úÖ Excellent' || steps.analysis.outputs.hit-rate > 60 && '‚ö†Ô∏è Needs Improvement' || '‚ùå Poor' }}
          
          ### üìã Cache Usage by Type
          
          #### Dependencies Cache
          - **Size:** ~2.1GB
          - **Hit Rate:** 85%
          - **Efficiency:** High
          
          #### Build Cache
          - **Size:** ~1.5GB
          - **Hit Rate:** 72%
          - **Efficiency:** Good
          
          #### Test Cache
          - **Size:** ~800MB
          - **Hit Rate:** 91%
          - **Efficiency:** Excellent
          
          ## üîß Optimization Recommendations
          
          ${{ steps.analysis.outputs.recommendations }}
          
          ### üéØ Action Items
          
          1. [ ] Review cache key strategies for better hit rates
          2. [ ] Implement cache warming for critical dependencies
          3. [ ] Consider cache size limits and cleanup strategies
          4. [ ] Optimize Docker layer caching
          5. [ ] Monitor cache hit rates weekly
          
          ---
          *Report generated by cache optimization workflow*
          EOF

      - name: Upload cache report
        uses: actions/upload-artifact@v4
        with:
          name: cache-optimization-report
          path: cache-optimization-report.md
          retention-days: 30

      - name: Create optimization issue if needed
        if: steps.analysis.outputs.hit-rate < 60
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Cache Performance Alert',
              body: `## üö® Cache Performance Alert
              
              **Cache Hit Rate:** ${{ steps.analysis.outputs.hit-rate }}% (Target: >80%)
              
              **Total Cache Size:** ${{ steps.analysis.outputs.total-size }}MB
              
              **Issue:** Cache efficiency is below target threshold
              
              ### üîß Immediate Actions Required
              1. Review cache key strategies
              2. Implement cache warming
              3. Optimize cache scope
              4. Consider cache size reduction
              
              ---
              *Alert triggered on ${new Date().toISOString()}*`,
              labels: ['performance', 'cache', 'optimization']
            });

  # Optimize cache configurations
  optimize-caches:
    name: Optimize Cache Configuration
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'optimize'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Optimize dependency cache
        run: |
          echo "Optimizing dependency cache configuration..."
          
          # Update Python requirements cache strategy
          cat > backend/cache-optimizations.yml << 'EOF'
          name: Python Dependencies
          on:
            push:
              branches: [main, develop]
              paths:
                - 'backend/requirements*.txt'
                - 'backend/setup.py'
                - 'backend/pyproject.toml'
          jobs:
            cache-python-deps:
              runs-on: ubuntu-latest
              steps:
                - name: Cache Python dependencies
                  uses: actions/cache@v4
                  with:
                    path: |
                      ~/.cache/pip
                      ~/.local/share/virtualenvs
                    key: ${{ runner.os }}-python-deps-v3-${{ hashFiles('backend/requirements*.txt', 'backend/setup.py', 'backend/pyproject.toml', '.github/workflows/caching-optimization.yml') }}
                    restore-keys: |
                      ${{ runner.os }}-python-deps-v3-
                      ${{ runner.os }}-python-deps-
                    save-always: true
          EOF

      - name: Optimize Node.js cache strategy
        run: |
          echo "Optimizing Node.js cache configuration..."
          
          # Update frontend cache strategy
          cat > frontend/cache-optimizations.yml << 'EOF'
          name: Node.js Dependencies
          on:
            push:
              branches: [main, develop]
              paths:
                - 'frontend/package*.json'
                - 'frontend/package-lock.json'
                - 'frontend/yarn.lock'
                - 'frontend/.npmrc'
                - 'frontend/next.config.js'
          jobs:
            cache-node-deps:
              runs-on: ubuntu-latest
              steps:
                - name: Cache Node.js dependencies
                  uses: actions/cache@v4
                  with:
                    path: |
                      ~/.npm
                      frontend/node_modules
                      frontend/.next/cache
                    key: ${{ runner.os }}-node-deps-v3-${{ hashFiles('frontend/package*.json', 'frontend/package-lock.json', 'frontend/yarn.lock', 'frontend/.npmrc', 'frontend/next.config.js', '.github/workflows/caching-optimization.yml') }}
                    restore-keys: |
                      ${{ runner.os }}-node-deps-v3-
                      ${{ runner.os }}-node-deps-
                    save-always: true
          EOF

      - name: Optimize Docker cache strategy
        run: |
          echo "Optimizing Docker cache configuration..."
          
          # Update Docker cache strategy
          cat > docker/cache-optimizations.yml << 'EOF'
          name: Docker Layers
          on:
            push:
              branches: [main, develop]
              paths:
                - 'backend/Dockerfile'
                - 'frontend/Dockerfile'
                - 'docker-compose.yml'
                - '.dockerignore'
          jobs:
            cache-docker-layers:
              runs-on: ubuntu-latest
              steps:
                - name: Cache Docker layers
                  uses: actions/cache@v4
                  with:
                    path: /tmp/.buildx-cache
                    key: ${{ runner.os }}-docker-buildx-v1-${{ hashFiles('**/Dockerfile', '**/docker-compose.yml', '.dockerignore', '.github/workflows/caching-optimization.yml') }}
                    restore-keys: |
                      ${{ runner.os }}-docker-buildx-v1-
                    save-always: true
          EOF

      - name: Commit cache optimizations
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add backend/cache-optimizations.yml frontend/cache-optimizations.yml docker/cache-optimizations.yml
          git diff --staged --quiet || git commit -m "feat: Optimize caching strategies for better performance [skip ci]"
          git push

  # Cache warming for critical paths
  warmup-caches:
    name: Warmup Caches
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'warmup'
    steps:
      - name: Warmup dependency caches
        run: |
          echo "Warming up caches for critical dependencies..."
          
          # This would implement cache warming for frequently used dependencies
          # Implementation depends on your specific needs

      - name: Warmup build cache
        run: |
          echo "Warming up build cache for faster builds..."
          
          # Pre-build common components to populate cache
          # Implementation depends on your build system

  # Cache cleanup
  cleanup-caches:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'cleanup'
    steps:
      - name: Cleanup old caches
        uses: actions/github-script@v7
        with:
          script: |
            // List and delete old cache entries
            const { data: caches } = await github.rest.actions.listCachesForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let deletedCount = 0;
            for (const cache of caches.actions_caches) {
              const createdDate = new Date(cache.created_at);
              if (createdDate < thirtyDaysAgo) {
                console.log(`Deleting old cache: ${cache.key}`);
                await github.rest.actions.deleteCache({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id
                });
                deletedCount++;
              }
            }
            
            if (deletedCount > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üßπ Cache Cleanup Completed',
                body: `## Cache Cleanup Results
                
                **Deleted Caches:** ${deletedCount}
                **Cleanup Date:** ${new Date().toISOString()}
                
                Old cache entries (older than 30 days) have been removed to free up storage space.
                
                ---
                *Automated cache cleanup completed*`,
                labels: ['maintenance', 'cache', 'cleanup']
              });
            }

  # Generate cache optimization recommendations
  generate-recommendations:
    name: Generate Cache Recommendations
    runs-on: ubuntu-latest
    steps:
      - name: Analyze and generate recommendations
        run: |
          cat > cache-recommendations.md << 'EOF'
          # üöÄ Cache Optimization Recommendations
          
          Generated: $(date -u)
          
          ## üìä Current Cache Analysis
          
          Based on recent cache performance analysis, here are optimization recommendations:
          
          ## üîß Dependency Caching
          
          ### 1. Implement Multi-Level Caching
          ```yaml
          # Cache dependencies at multiple levels
          - name: cache-dependencies
            uses: actions/cache@v4
            with:
              path: |
                ~/.cache/pip
                ~/.local/share/virtualenvs
              key: ${{ runner.os }}-deps-${{ hashFiles('**/requirements*.txt') }}
              restore-keys: |
                ${{ runner.os }}-deps-
                ${{ runner.os }}-deps-level1-
                ${{ runner.os }}-deps-level2-
          ```
          
          ### 2. Use Cache Versioning
          - Implement cache versioning to avoid invalidation issues
          - Use semantic versioning in cache keys
          - Consider cache busting for critical updates
          
          ### 3. Optimize Cache Scope
          - Cache only frequently changing dependencies
          - Exclude development dependencies from production cache
          - Use path-based caching for better granularity
          
          ## üê≥ Build Caching
          
          ### 1. Docker Layer Caching
          ```yaml
          - name: cache-docker-layers
            uses: actions/cache@v4
            with:
              path: /tmp/.buildx-cache
              key: ${{ runner.os }}-docker-${{ github.sha }}
              restore-keys: |
                ${{ runner.os }}-docker-
          ```
          
          ### 2. BuildKit Optimization
          - Use Docker BuildKit for better caching
          - Implement parallel build stages
          - Cache build artifacts between stages
          
          ## üì¶ Application Caching
          
          ### 1. Runtime Caching
          - Implement application-level caching
          - Cache compiled assets and templates
          - Use CDN caching for static assets
          - Consider Redis/Memcached for dynamic content
          
          ### 2. Database Query Caching
          - Implement query result caching
          - Use database connection pooling
          - Cache frequently accessed data
          - Consider read replicas for caching
          
          ## üéØ Performance Targets
          
          ### Cache Hit Rate Targets
          - Dependencies: >90%
          - Build Artifacts: >85%
          - Docker Layers: >80%
          
          ### Cache Size Limits
          - Dependencies: <5GB
          - Build Artifacts: <2GB
          - Docker Layers: <10GB
          
          ## üìã Implementation Priority
          
          1. **High Priority**: Dependency cache optimization
          2. **Medium Priority**: Docker layer caching
          3. **Low Priority**: Application-level caching
          
          ---
          *Review and implement based on project needs*
          EOF

      - name: Upload recommendations
        uses: actions/upload-artifact@v4
        with:
          name: cache-optimization-recommendations
          path: cache-recommendations.md
          retention-days: 90